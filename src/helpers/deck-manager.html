<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="deck-manager">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 0px;
      }
    </style>
  </template>

  <script>
    class DeckManager extends Polymer.Element {
      static get is() { return 'deck-manager'; }

      static get properties() {
        return {
          addingCard: {
            type: Boolean,
            value: false
          },
          deck: {
            type: Array,
            value: function () { return []; }
          },
          id: {
            type: String,
            value: ''
          },
          limit: {
            type: Number,
            value: 0
          }
        };
      }

      ready() {
        super.ready();
        document.addEventListener('remove-card-from-' + this.id, e => this.removeCard(e));
        document.addEventListener('clear-card-from-' + this.id, e => this.clearCard(e));
      }

      addCard(card) {
        this.addingCard = true;
        var count = 0;
        this.deck.forEach(function(currentCard) {
          if (card.name == currentCard.name) {
            count++;
          }
        });

        if (count < 3 && this.deck.length < this.limit) {
          if (count == 0) {
            count++;
            document.dispatchEvent(new CustomEvent('add-card-to-' + card.deck, {detail: {card: card}}));
          } else {
            count++;
            document.dispatchEvent(new CustomEvent('update-count', {detail: {card: card, count: count}}));
          }
          this.deck.push(card);
          document.dispatchEvent(new CustomEvent('update-count-for-' + this.id, {detail: {count: this.deck.length}}));
          document.dispatchEvent(new CustomEvent('draw-card', {detail: {card: card}}));
        } else {
          document.dispatchEvent(new CustomEvent('card-limit', {detail: {card: card}}));
        }
        this.addingCard = false;
      }

      findCardInDeck(name) {
        for (var i = 0; i < this.deck.length; i++) {
          for (var j = 0; j < this.deck[i].ids.length; j++) {
            if (name == this.deck[i].name || name == this.deck[i].ids[j]) {
              return this.deck[i];
            }
          }
        }
      }

      removeCard(e) {
        var itemToRemove;
        for (var i = 0; i < this.deck.length; i++) {
          if (e.detail.card.name == this.deck[i].name) {
            itemToRemove = i;
            break;
          }
        }
        this.deck.splice(itemToRemove, 1);
        document.dispatchEvent(new CustomEvent('update-count-for-' + this.id, {detail: {count: this.deck.length}}));
      }

      clearCard(e) {
        for (var i = 0; i < e.detail.card.count; i++) {
          document.dispatchEvent(new CustomEvent('remove-card-from-' + this.id, {detail: {card: e.detail.card}}));
        }
      }

      createYDK() {
        var YDK = "";
        if (this.deck.length > 0) {
          var prefix = this.id == "side" ? "!" : "#";
          YDK += prefix + this.id + "\n"
          for (var i = 0; i < this.deck.length; i++) {
            YDK += this.deck[i].ids[0] + "\n";
          }
        }
        return YDK;
      }
    }

    window.customElements.define(DeckManager.is, DeckManager);
  </script>
</dom-module>